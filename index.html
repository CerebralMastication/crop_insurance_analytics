<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Introduction to R</title>
    <meta charset="utf-8" />
    <meta name="author" content="James (JD) Long" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Introduction to R
## <br/>with the Tidyverse<br/>and RMA SoB data
### James (JD) Long
### Renaissance Reinsurance
### updated: 2019-11-12

---




&lt;style type="text/css"&gt;

.huge .remark-code { /
  font-size: 150% !important;
}
.tiny .remark-code { 
  font-size: 50% !important;
}
.medium .remark-code { 
  font-size: 75% !important;
}
&lt;/style&gt;

---

background-image: url("03_images/disclaimer.png")
background-position: center
background-size: contain

---

background-image: url("03_images/rcookbook.png")
background-position: center
background-size: contain

---
class: center, middle
# A Little About Me...

---

# Why am I doing this?

## Who's getting paid &amp; how?

---
class: center, middle
# Why R? 

--

## Interactive

--

## Widely Used

--

## Data Analysis and Stats First

--

## Great Addon Packages (Tidyverse)

--

---

background-image: url("03_images/stats.jpg")
background-position: center
background-size: contain

---

background-image: url("03_images/google_ResearcHers.png")
background-position: center
background-size: contain

---

# What's up with the Tidyverse?

--

## Libraries that work well together

--

## Consistent Syntax

--

## Easier to Learn / Remember

--

## Sponsored by RStudio

---

# Tidyverse (core)

.pull-left[
## 👇 ***Our Focus Today***
### `dplyr` - data manupliation 
### `ggplot2` - visualization 
### `readr` - data import 
### `tidyr` - data rearrangement (tidy-ing)
]
.pull-right[
### `purrr` - functional programming with lists
### `tibble` - modern data frames
### `stringr` - string manipulation
### `forcats` - categorical data
]

---

background-image: url("03_images/konami.jpg")
background-position: center
background-size: contain

---

# Example Cheats

--
.pull-left[
## RStudio Add ins:
### `clipr` - output to clipboard
### `datapasta` - paste from clipboard
### `esquisse` - quick start graphs
]
--
.pull-right[
## Packages:
### `Tidyverse` - shared social norms
### `xlsx` - write to Excel

## Cheat Sheets:
### In the Help menu!
]

---

background-image: url("03_images/cheatsheets.png")
background-position: center
background-size: contain

---

background-image: url("03_images/dplyr_cheat.png")
background-position: center
background-size: contain

---

class: center, middle

# Let's Open&lt;br/&gt;`RStudio.cloud`

## http://bit.ly/cropins_r

Save the project to your workspace. 

---

background-image: url("03_images/rstudio.cloud.png")
background-position: center
background-size: contain

---

.center[
`ctrl + shift + n` - for new document

![hello_world](03_images/hello_world.png)

]

---

background-image: url("03_images/hello_yall.png")
background-position: center
background-size: contain

---

# Now your turn:


## Create a variable and shove some text into it with `&lt;-`
## Then `print()` that to the screen


Save your script now. Update your script with each exercise. These are your notes for later. 
---

# Let's play with some data! 

---


```r
library(tidyverse)
```

```
## ── Attaching packages ───────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──
```

```
## ✔ ggplot2 3.2.1          ✔ purrr   0.3.3     
## ✔ tibble  2.1.3          ✔ dplyr   0.8.3.9000
## ✔ tidyr   1.0.0.9000     ✔ stringr 1.4.0     
## ✔ readr   1.3.1          ✔ forcats 0.4.0
```

```
## ── Conflicts ──────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks skimr::filter(), stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
```

---


```r
sob_limited_group_1 &lt;- read_csv("01_data/sob_limited_group_1.csv")
```

```
## Parsed with column specification:
## cols(
##   year = col_double(),
##   stFips = col_double(),
##   stAbbr = col_character(),
##   coFips = col_character(),
##   coName = col_character(),
##   cropCd = col_character(),
##   cropName = col_character(),
##   planCd = col_double(),
##   planAbbr = col_character(),
##   coverCat = col_character(),
##   deliveryType = col_character(),
##   covLevel = col_double(),
##   liab = col_double(),
##   prem = col_double(),
##   indem = col_double()
## )
```

---

# But what about equals signs?

```r
sob_limited_group_1 = read_csv("01_data/sob_limited_group_1.csv")
```

```
## Parsed with column specification:
## cols(
##   year = col_double(),
##   stFips = col_double(),
##   stAbbr = col_character(),
##   coFips = col_character(),
##   coName = col_character(),
##   cropCd = col_character(),
##   cropName = col_character(),
##   planCd = col_double(),
##   planAbbr = col_character(),
##   coverCat = col_character(),
##   deliveryType = col_character(),
##   covLevel = col_double(),
##   liab = col_double(),
##   prem = col_double(),
##   indem = col_double()
## )
```


---

# But arrows are directional!

```r
read_csv("01_data/sob_limited_group_1.csv") -&gt;
  sob_limited_group_1
```

```
## Parsed with column specification:
## cols(
##   year = col_double(),
##   stFips = col_double(),
##   stAbbr = col_character(),
##   coFips = col_character(),
##   coName = col_character(),
##   cropCd = col_character(),
##   cropName = col_character(),
##   planCd = col_double(),
##   planAbbr = col_character(),
##   coverCat = col_character(),
##   deliveryType = col_character(),
##   covLevel = col_double(),
##   liab = col_double(),
##   prem = col_double(),
##   indem = col_double()
## )
```


---

# Control + Click on a data frame...

```r
View(sob_limited_group_1)
```

```r
sob_limited_group_1 %&gt;%
   View
```

---

# wait.. wft is `%&gt;%`?

--


![pipe](03_images/pipe.jpeg)

---

# Why Pipes?

## Traditional Syntax
```r
harvest(
  spray(
    fertilize(
      plant( some_acres, crop = "corn", ppa = 38000),
        n = 10, p = 10, k = 10), 
    plan = "roundup")
  )
```
-or- 
```r
planted_acres &lt;- plant( some_acres, crop = "corn", ppa = 38000)
fert_planted_acres &lt;- fertilize(planted_acres, 
                                n = 10, p = 10, k = 10)
spray_fert_planted_acres &lt;- spray(fert_planted_acres, 
                                  plan = "roundup")
harvest(spray_fert_planted_acres)
```

---
# Pipe Hotness

.huge[
```r
some_acres %&gt;%
  plant(crop = "corn", ppa = 38000) %&gt;%
  fertilize(n=10, p=10, k=10) %&gt;%
  spray(plan = "roundup") %&gt;%
  harvest() -&gt;
  corn_crop
```
]
---
  
# Or in Kentucky
.huge[
```r
bourbon_bottle %&gt;%
  open(twist=“left”) %&gt;%
  pour(oz=4) %&gt;%
  enjoy() -&gt;
  bad_decisions
```
]

---

# Back to the data... 

---
# Type the data frame name into the console


```r
sob_limited_group_1
```

```
## # A tibble: 515,784 x 15
##     year stFips stAbbr coFips coName cropCd cropName planCd planAbbr
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   
##  1  1989     17 IL     000    All O… 0011   WHEAT        90 APH     
##  2  1989     17 IL     000    All O… 0041   CORN         90 APH     
##  3  1989     17 IL     000    All O… 0081   SOYBEANS     90 APH     
##  4  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  5  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  6  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  7  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  8  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  9  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
## 10  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
## # … with 515,774 more rows, and 6 more variables: coverCat &lt;chr&gt;,
## #   deliveryType &lt;chr&gt;, covLevel &lt;dbl&gt;, liab &lt;dbl&gt;, prem &lt;dbl&gt;,
## #   indem &lt;dbl&gt;
```
---
# Time to cheat... `↑↑↓↓←→←→BA`
```r
library(skimr)
```

--

.medium[

```r
skim(sob_limited_group_1)
```

```
## Skim summary statistics
##  n obs: 515784 
##  n variables: 15 
## 
## ── Variable type:character ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────
##      variable missing complete      n min max empty n_unique
##        coFips       0   515784 515784   3   3     0      106
##        coName       0   515784 515784   3  18     0      348
##      coverCat       0   515784 515784   1   1     0        4
##        cropCd       0   515784 515784   4   4     0        3
*##      cropName       0   515784 515784   4   8     0        3
##  deliveryType       0   515784 515784   4   4     0        4
##      planAbbr       0   515784 515784   2   9     0       19
*##        stAbbr       0   515784 515784   2   2     0        5
## 
## ── Variable type:numeric ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
##  variable missing complete      n       mean         sd     p0      p25
##  covLevel       0   515784 515784       0.64       0.21      0     0.55
##     indem       0   515784 515784   65354.26  554609.46 -37199     0   
##      liab       0   515784 515784 1282142.29 4608067.69      0 14021   
##    planCd       0   515784 515784      44.67      36.96      1     3   
##      prem       0   515784 515784   91599.82  328027.88      0   636   
##    stFips       0   515784 515784      21.72       5.4      17    17   
##      year       0   515784 515784    2005.95       7.37   1989  2000   
##       p50       p75       p100     hist
##       0.7      0.75    0.95    ▂▁▁▁▅▇▆▃
##       0     8923       5.9e+07 ▇▁▁▁▁▁▁▁
##  111937   619887.25    1.6e+08 ▇▁▁▁▁▁▁▁
##      44       90      90       ▇▁▂▅▁▁▁▇
##    5763    37327.25    1.1e+07 ▇▁▁▁▁▁▁▁
##      19       27      31       ▇▃▁▁▁▃▁▃
##    2006     2012    2018       ▂▃▅▇▇▆▇▇
```
]

---

background-image: url("03_images/dplyr_wrangling.png")
background-position: center
background-size: contain


---

# `dplyr` verbs for manipulation

* `filter` - filter rows
* `select` - filter columns
* `mutate` - create new columns
* `group_by` - chunk that junk
* `summarize` - summery of each chunk
* `arrange` - sort order

---

# `filter` - filter rows

.medium[

```r
sob_limited_group_1 %&gt;%
  filter(stAbbr == "IA" &amp; cropName == "CORN") %&gt;%
  skim
```

```
## Skim summary statistics
##  n obs: 52565 
##  n variables: 15 
## 
## ── Variable type:character ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────
##      variable missing complete     n min max empty n_unique
##        coFips       0    52565 52565   3   3     0      101
##        coName       0    52565 52565   3  18     0      102
##      coverCat       0    52565 52565   1   1     0        4
##        cropCd       0    52565 52565   4   4     0        1
##      cropName       0    52565 52565   4   4     0        1
##  deliveryType       0    52565 52565   4   4     0        4
##      planAbbr       0    52565 52565   2   9     0       19
##        stAbbr       0    52565 52565   2   2     0        1
## 
## ── Variable type:numeric ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
##  variable missing complete     n       mean         sd     p0     p25
##  covLevel       0    52565 52565       0.65       0.21      0     0.6
##     indem       0    52565 52565  138308.98  960655.68 -13046     0  
##      liab       0    52565 52565 2483435.47 7394837.63      0 49020  
##    planCd       0    52565 52565      44.03      36.26      1     3  
##      prem       0    52565 52565  155798.39  467817.74      0  1490  
##    stFips       0    52565 52565      19          0        19    19  
##      year       0    52565 52565    2005.4        7.24   1989  2000  
##       p50       p75          p100     hist
##       0.7       0.8       0.95    ▂▁▁▁▃▇▆▃
##       0     13768         3.7e+07 ▇▁▁▁▁▁▁▁
##  279569   1434295         1.2e+08 ▇▁▁▁▁▁▁▁
##      44        90        90       ▇▁▃▅▁▁▁▇
##   11455     75124   8776695       ▇▁▁▁▁▁▁▁
##      19        19        19       ▁▁▁▇▁▁▁▁
##    2006      2011      2018       ▂▃▆▇▇▆▇▆
```
]

---

# `filter` supports nested parens


```r
sob_limited_group_1 %&gt;%
  filter((stAbbr == "IA" &amp; cropName == "CORN") |
           (stAbbr == "IL" &amp; cropName == "SOYBEANS"))
```

The secret is: 
* `&amp;` = and
* `|` = or

---

# `select` - pick columns

.medium[

```r
sob_limited_group_1 %&gt;%
  filter((stAbbr == "IA" &amp; cropName == "CORN") |
           (stAbbr == "IL" &amp; cropName == "SOYBEANS")) %&gt;%
  select(stAbbr, cropName)
```

```
## # A tibble: 106,406 x 2
##    stAbbr cropName
##    &lt;chr&gt;  &lt;chr&gt;   
##  1 IL     SOYBEANS
##  2 IL     SOYBEANS
##  3 IL     SOYBEANS
##  4 IL     SOYBEANS
##  5 IL     SOYBEANS
##  6 IL     SOYBEANS
##  7 IL     SOYBEANS
##  8 IL     SOYBEANS
##  9 IL     SOYBEANS
## 10 IL     SOYBEANS
## # … with 106,396 more rows
```
]

---
# Exercise Time...

1. Take `sob_limited_group_1` and filter it to include all records for IA and MN, and only Corn for the rest of the states. 
1. keep only the following fields:
`year, stAbbr, coName, cropName, planAbbr, prem, indem`



5 minutes... use your post it notes
---

# Exercise Solution...            

--
.huge[

```r
sob_limited_group_1 %&gt;%
  filter((stAbbr == "IA" | stAbbr == "MN") |
           (cropName == "CORN")) %&gt;%
  select(year, stAbbr, coName, cropName, planAbbr, prem, indem) 
```

```
## # A tibble: 327,105 x 7
##     year stAbbr coName             cropName planAbbr   prem  indem
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;              &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;
##  1  1989 IL     All Other Counties CORN     APH           0      0
##  2  1989 IL     Adams              CORN     APH           0      0
##  3  1989 IL     Adams              CORN     APH         754   1346
##  4  1989 IL     Adams              CORN     APH       35815  91313
##  5  1989 IL     Adams              CORN     APH       86661 221857
##  6  1989 IL     Adams              CORN     APH           0      0
##  7  1989 IL     Adams              CORN     APH        1556   5136
##  8  1989 IL     Adams              CORN     APH       93238 252274
##  9  1989 IL     Adams              CORN     APH      115249 419128
## 10  1989 IL     Alexander          CORN     APH           0      0
## # … with 327,095 more rows
```
]

---
# Double check: (bonus verb `distinct`)


```r
sob_limited_group_1 %&gt;%
  filter((stAbbr == "IA" | stAbbr == "MN") |
           (cropName == "CORN")) %&gt;%
  distinct(cropName, stAbbr) %&gt;% 
  arrange( cropName, stAbbr)
```

```
## # A tibble: 9 x 2
##   cropName stAbbr
##   &lt;chr&gt;    &lt;chr&gt; 
## 1 CORN     IA    
## 2 CORN     IL    
## 3 CORN     IN    
## 4 CORN     MN    
## 5 CORN     NE    
## 6 SOYBEANS IA    
## 7 SOYBEANS MN    
## 8 WHEAT    IA    
## 9 WHEAT    MN
```

---

background-image: url("03_images/doing.gif")
background-position: center
background-size: contain

---

# `mutate` - create new columns           
.medium[
```r
dataframe %&gt;%
  mutate( new_column = function(something) )
```
]

---

# `mutate` - create new columns           


```r
sob_limited_group_1 %&gt;%
  filter((stAbbr == "IA" | stAbbr == "MN") |
           (cropName == "CORN")) %&gt;%
  select(year, stAbbr, coName, cropName, planAbbr, prem, indem) %&gt;%
* mutate(state_crop = paste(stAbbr, cropName))
```

```
## # A tibble: 327,105 x 8
##     year stAbbr coName           cropName planAbbr   prem  indem state_crop
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;            &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     
##  1  1989 IL     All Other Count… CORN     APH           0      0 IL CORN   
##  2  1989 IL     Adams            CORN     APH           0      0 IL CORN   
##  3  1989 IL     Adams            CORN     APH         754   1346 IL CORN   
##  4  1989 IL     Adams            CORN     APH       35815  91313 IL CORN   
##  5  1989 IL     Adams            CORN     APH       86661 221857 IL CORN   
##  6  1989 IL     Adams            CORN     APH           0      0 IL CORN   
##  7  1989 IL     Adams            CORN     APH        1556   5136 IL CORN   
##  8  1989 IL     Adams            CORN     APH       93238 252274 IL CORN   
##  9  1989 IL     Adams            CORN     APH      115249 419128 IL CORN   
## 10  1989 IL     Alexander        CORN     APH           0      0 IL CORN   
## # … with 327,095 more rows
```

try it... 


---

# How to get help?

`?paste`

--

Google: R combine strings

![goog](03_images/google.png)

---


# Bonus: `rename` - guess what it does?

--


```r
sob_limited_group_1 %&gt;%
  select(year, stAbbr, coName, cropName, planAbbr, prem, indem) %&gt;%
* rename(county_name = coName)
```

```
## # A tibble: 515,784 x 7
##     year stAbbr county_name        cropName planAbbr  prem indem
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;              &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1  1989 IL     All Other Counties WHEAT    APH          0     0
##  2  1989 IL     All Other Counties CORN     APH          0     0
##  3  1989 IL     All Other Counties SOYBEANS APH          0     0
##  4  1989 IL     Adams              WHEAT    APH          0     0
##  5  1989 IL     Adams              WHEAT    APH         14     0
##  6  1989 IL     Adams              WHEAT    APH       1551     0
##  7  1989 IL     Adams              WHEAT    APH       7886   145
##  8  1989 IL     Adams              WHEAT    APH          0     0
##  9  1989 IL     Adams              WHEAT    APH       2316     0
## 10  1989 IL     Adams              WHEAT    APH       4026  2294
## # … with 515,774 more rows
```
Notice the argument order...

---

# `group_by` - change the grouping (resolution) of future operations


```r
sob_limited_group_1 %&gt;%
  group_by(year, stAbbr)
```

```
## # A tibble: 515,784 x 15
*## # Groups:   year, stAbbr [150]
##     year stFips stAbbr coFips coName cropCd cropName planCd planAbbr
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   
##  1  1989     17 IL     000    All O… 0011   WHEAT        90 APH     
##  2  1989     17 IL     000    All O… 0041   CORN         90 APH     
##  3  1989     17 IL     000    All O… 0081   SOYBEANS     90 APH     
##  4  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  5  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  6  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  7  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  8  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
##  9  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
## 10  1989     17 IL     001    Adams  0011   WHEAT        90 APH     
## # … with 515,774 more rows, and 6 more variables: coverCat &lt;chr&gt;,
## #   deliveryType &lt;chr&gt;, covLevel &lt;dbl&gt;, liab &lt;dbl&gt;, prem &lt;dbl&gt;,
## #   indem &lt;dbl&gt;
```

---
# `summarize` - do a group operation on grouped data


```r
sob_limited_group_1 %&gt;%
  group_by(year, stAbbr) %&gt;%
  summarize( prem = sum(prem)) -&gt;
  state_prem

state_prem
```

```
## # A tibble: 150 x 3
## # Groups:   year [30]
##     year stAbbr      prem
##    &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;
##  1  1989 IA     108576188
##  2  1989 IL      54787066
##  3  1989 IN      15942467
##  4  1989 MN      68654761
##  5  1989 NE      41626780
##  6  1990 IA      73309044
##  7  1990 IL      29600800
##  8  1990 IN       9413259
##  9  1990 MN      65679262
## 10  1990 NE      26652326
## # … with 140 more rows
```
Be sure and assign this one to a data frame object. We'll need that in a minute. 
---

# Cool story, bro... how about a graph?
.huge[

`↑↑↓↓←→←→BA`

```r
install.packages("esquisse")
```

/ɛs.kis/

A quick first sketch of an idea.

`esquisse` gets us a fast first draft of a graph. It gives us `ggplot2` code we then customize. 
]
---


background-image: url("03_images/esquisse.png")
background-position: center
background-size: contain


---


&lt;img src="03_images/es1.png" width="600" /&gt;

&lt;img src="03_images/es2.png" width="600" /&gt;

&lt;img src="03_images/export.png" width="250" /&gt;


---

# `esquisse` works best (only?) if you have your data aggregated to the unit of display

Generally this is true of `ggplot2` as well. 

---

# Let's talk about "long" vs "wide" data...

### If adding new data never adds columns, then your data is "long"

### Rule of thumb: keep your data long in storage and analysis until you ***really*** need it wide. Like to calculate correlations. 

![export](03_images/l_vs_w.png)

---

# 🤔 - `ggplot` likes its data "long"

--

## Excel likes its data wide. 

--

This trips everybody up. 

---
# So how do we get make it a different shape?


## `pivot_wider`
## `pivot_longer`

---

# let's `pivot_wider`

```r
state_prem %&gt;%
  pivot_wider(names_from = stAbbr, 
              values_from = prem) -&gt;
  wide_prem
wide_prem
```

```
## # A tibble: 30 x 6
## # Groups:   year [30]
##     year        IA       IL       IN        MN       NE
##    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1  1989 108576188 54787066 15942467  68654761 41626780
##  2  1990  73309044 29600800  9413259  65679262 26652326
##  3  1991  62933287 27266873  9821834  49486953 24415359
##  4  1992  64959731 41617752 16401088  48087453 33477953
##  5  1993  59587322 39395926 15837416  46502008 33481087
##  6  1994  83179160 50483454 18913067  74694566 42347611
##  7  1995 100568854 76795570 30787110  92850790 61650261
##  8  1996  70959128 93528285 37081409 118068933 45860721
##  9  1997 136029770 84687641 38274003 119678510 92084929
## 10  1998 148390218 93916521 46665391 129245516 99224406
## # … with 20 more rows
```

---
# Let's calculate correlations, since we can


```r
wide_prem %&gt;%
* ungroup() %&gt;%
* select(-year) %&gt;%
  cor()
```

```
##           IA        IL        IN        MN        NE
## IA 1.0000000 0.9916119 0.9956536 0.9967789 0.9974921
## IL 0.9916119 1.0000000 0.9971414 0.9896964 0.9932751
## IN 0.9956536 0.9971414 1.0000000 0.9931811 0.9979541
## MN 0.9967789 0.9896964 0.9931811 1.0000000 0.9950238
## NE 0.9974921 0.9932751 0.9979541 0.9950238 1.0000000
```

---
# let's reverse it with `pivot_longer`


```r
wide_prem %&gt;%
  pivot_longer(cols = -year,
               names_to = "stAbbr",
               values_to = "prem")
```

```
## # A tibble: 150 x 3
## # Groups:   year [30]
##     year stAbbr      prem
##    &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;
##  1  1989 IA     108576188
##  2  1989 IL      54787066
##  3  1989 IN      15942467
##  4  1989 MN      68654761
##  5  1989 NE      41626780
##  6  1990 IA      73309044
##  7  1990 IL      29600800
##  8  1990 IN       9413259
##  9  1990 MN      65679262
## 10  1990 NE      26652326
## # … with 140 more rows
```

---

```r
wide_prem %&gt;%
  pivot_longer(cols = -year,
               names_to = "stAbbr",
               values_to = "prem")
```

## 🤔 - Two "gotchas" 

## 1. What's that `cols` argument? (it's like `select`)

## 2. Must quote the new field names

---

# Excel Pivot Tables do two things:

1. Aggregation
1. Reshaping 

--

# With R we do those in 2 different steps. 

1. `group_by` and `summarize`  (I'm counting these as one thing...)
1. `pivot_wider`  or  `pivot_longer`

--

💡 - `pivot_*` are brand spanking new &amp; not in the cheatsheets yet - also not in *R Cookbook*

---
# Exercise Time! 

yellow Post Its up!

Start with the `sob_limited_group_1` data frame

Calculate combined corn &amp; soy crop loss ratio by year. Loss ratio is `indem/prem`.

use `dplyr`-fu to get your data wrangled. 

Then create a `ggplot` point graph showing the LR by year. 

**BONUS:** Make the points scale with the LR 

15 minutes. 


---
# A Solution


```r
sob_limited_group_1 %&gt;%
* filter(cropName %in% c("CORN", "SOYBEANS")) %&gt;%
  group_by(year) %&gt;%
  summarize(lr = sum(indem) / sum(prem)) -&gt;
  lr_year

ggplot(lr_year) +
  aes(x = year, y = lr, size = lr) +
  geom_point(colour = "#0c4c8a") +
 theme_minimal()
```

---
# A Solution

![](intro_to_r_files/figure-html/unnamed-chunk-26-1.png)&lt;!-- --&gt;

---

# Can you make this a bar chart with `esquisse`?

---


# Maybe we should do some `ggplot`

![ggplot](03_images/ggplot2_exploratory.png)


---
# `ggplot` 

```r
ggplot(lr_year) +
  aes(x = year, y = lr, size = lr) +
  geom_point(colour = "#0c4c8a") +
  theme_minimal()
```

&lt;img src="intro_to_r_files/figure-html/unnamed-chunk-27-1.png" height="350" /&gt;
---

# that bar plot though...


```r
ggplot(lr_year) +
 aes(x = year, y = lr) +
*geom_bar(stat="identity") +
 theme_minimal()
```

&lt;img src="intro_to_r_files/figure-html/unnamed-chunk-28-1.png" height="300" /&gt;

*R Graphics Cookbook* https://r-graphics.org/chapter-bar-graph

🤔 - Everybody trips on `stat="identity"`

---

# Joining data

## Very much like SQL joins (with better defaults)

### `inner_join` - only the matching data from both tables 
### `full_join` - all data from both tables
### `left_join` - all data from the left, and the matches from the right
### `right_join` - all data from the right, and the matches from the left

---
# Excel `vlookup` ...

## Imagine your starting table in Excel as your ***left*** table. Then a `vlookup` is like a `left_join`

## There is no `vlookup` that's like `full` or `inner` join

---

### `inner_join`


![inner_ven](03_images/inner_v.png)
![inner_cheat](03_images/inner.png)

---

### `full_join`


![inner_ven](03_images/full_v.png)
![inner_cheat](03_images/full.png)

---

### `left_join`


![inner_ven](03_images/left_v.png)
![inner_cheat](03_images/left.png)


---

### `right_join`


![inner_ven](03_images/right_v.png)
![inner_cheat](03_images/right.png)

---
# Inner Join Example


```r
sob_limited_group_1 %&gt;%
* group_by(year, stAbbr, cropName) %&gt;%
  summarize(st_crop_yr_prem = sum(prem)) -&gt;
  st_crop_yr_prem

sob_limited_group_1 %&gt;%
* group_by(year, stAbbr, cropName, coName) %&gt;%
  summarize(st_crop_yr_co_prem = sum(prem)) -&gt;
  st_crop_yr_co_prem
```

---

.tiny[

```r
st_crop_yr_co_prem %&gt;%
  left_join(st_crop_yr_prem) 
```


```r
st_crop_yr_co_prem %&gt;%
  left_join(st_crop_yr_prem, by = c("year", "stAbbr", "cropName")) 
```

```
## # A tibble: 37,402 x 6
## # Groups:   year, stAbbr, cropName [450]
##     year stAbbr cropName coName           st_crop_yr_co_pr… st_crop_yr_prem
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;                        &lt;dbl&gt;           &lt;dbl&gt;
##  1  1989 IA     CORN     Adair                       726849        77710025
##  2  1989 IA     CORN     Adams                       500489        77710025
##  3  1989 IA     CORN     All Other Count…                 0        77710025
##  4  1989 IA     CORN     Allamakee                   515355        77710025
##  5  1989 IA     CORN     Appanoose                   278855        77710025
##  6  1989 IA     CORN     Audubon                     780587        77710025
##  7  1989 IA     CORN     Benton                      977636        77710025
##  8  1989 IA     CORN     Black Hawk                  835145        77710025
##  9  1989 IA     CORN     Boone                      1013970        77710025
## 10  1989 IA     CORN     Bremer                      706015        77710025
## # … with 37,392 more rows
```

]


---

# joins with missing values


```r
st_crop_yr_co_prem_missing &lt;- 
  read_csv("01_data/st_crop_yr_co_prem_missing.csv")
```

Now we have `st_crop_yr_co_prem` and `st_crop_yr_co_prem_missing` which is the same but with 1000 random records missing (rows totally deleted)

How can we use joins to create a data frame of *only* the combinations of `year, stAbbr, cropName, coName` that are missing from `st_crop_yr_co_prem_missing`?

Post its up! Work in small groups. 

Hints:

* First step is to `ungroup()`
* Be explicit about your join `by = c('var1', 'var2')`
* notice what `dplyr` does if there's a column name clash
* Run results through `skim` for sanity check
* to filter on missing values, look at `?is.na`

---
# One Solution

.tiny[

```r
st_crop_yr_co_prem %&gt;%
  ungroup() %&gt;%
  left_join(st_crop_yr_co_prem_missing,
            by = c("year", "stAbbr", "cropName", "coName")) %&gt;%
  skim
```

```
## Skim summary statistics
##  n obs: 37402 
##  n variables: 6 
## 
## ── Variable type:character ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────
##  variable missing complete     n min max empty n_unique
##    coName       0    37402 37402   3  18     0      348
##  cropName       0    37402 37402   4   8     0        3
##    stAbbr       0    37402 37402   2   2     0        5
## 
## ── Variable type:numeric ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
##              variable missing complete     n       mean         sd   p0
##  st_crop_yr_co_prem.x       0    37402 37402 1263187.05 1907662.21    0
##  st_crop_yr_co_prem.y    1000    36402 37402 1264965.39 1909977.5     0
##                  year       0    37402 37402    2003.92       8.51 1989
##       p25      p50        p75       p100     hist
##  58488    443933   1700028       1.8e+07 ▇▁▁▁▁▁▁▁
##  58203.25 444675.5 1701297.75    1.8e+07 ▇▁▁▁▁▁▁▁
##   1997      2004      2011    2018       ▆▇▆▇▇▆▇▇
```
]

---

# One Solution cont...

.tiny[

```r
st_crop_yr_co_prem %&gt;%
  left_join(st_crop_yr_co_prem_missing,
            by = c("year", "stAbbr", "cropName", "coName")) %&gt;%
  filter(is.na(st_crop_yr_co_prem.y))
```

```
## # A tibble: 1,000 x 6
## # Groups:   year, stAbbr, cropName [386]
##     year stAbbr cropName coName     st_crop_yr_co_prem… st_crop_yr_co_prem…
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;                    &lt;dbl&gt;               &lt;dbl&gt;
##  1  1989 IA     CORN     Cass                    848037                  NA
##  2  1989 IA     CORN     Davis                   304956                  NA
##  3  1989 IA     CORN     Washington              922814                  NA
##  4  1989 IA     CORN     Wright                  697579                  NA
##  5  1989 IA     SOYBEANS Adams                   255968                  NA
##  6  1989 IA     SOYBEANS Humboldt                380926                  NA
##  7  1989 IA     SOYBEANS Jones                   206454                  NA
##  8  1989 IL     CORN     Calhoun                  34518                  NA
##  9  1989 IL     CORN     Champaign               532659                  NA
## 10  1989 IL     CORN     Schuyler                158629                  NA
## # … with 990 more rows
```
]

---

# Logical Branching

## the `dplyr` approach is the function


`case_when()`


## typically used along with a `mutate`

```r
mutate( new_column = case_when(condition ~ result, 
                               condition2 ~ result2, 
                               condition3 ~ result2,
                               TRUE ~ else_result) )
```
First `TRUE` condition is the result
---

# Logical Branching


```r
st_crop_yr_co_prem %&gt;%
  mutate(size = case_when(st_crop_yr_co_prem &gt;= 1000000 ~ "MM+", 
                           TRUE ~ "&lt; MM"))
```

```
## # A tibble: 37,402 x 6
## # Groups:   year, stAbbr, cropName [450]
##     year stAbbr cropName coName             st_crop_yr_co_prem size 
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;                           &lt;dbl&gt; &lt;chr&gt;
##  1  1989 IA     CORN     Adair                          726849 &lt; MM 
##  2  1989 IA     CORN     Adams                          500489 &lt; MM 
##  3  1989 IA     CORN     All Other Counties                  0 &lt; MM 
##  4  1989 IA     CORN     Allamakee                      515355 &lt; MM 
##  5  1989 IA     CORN     Appanoose                      278855 &lt; MM 
##  6  1989 IA     CORN     Audubon                        780587 &lt; MM 
##  7  1989 IA     CORN     Benton                         977636 &lt; MM 
##  8  1989 IA     CORN     Black Hawk                     835145 &lt; MM 
##  9  1989 IA     CORN     Boone                         1013970 MM+  
## 10  1989 IA     CORN     Bremer                         706015 &lt; MM 
## # … with 37,392 more rows
```

---
# Logical Branching

In "plinko" we need multiple conditions... use multiple pipe steps

.tiny[

```r
st_crop_yr_co_prem %&gt;%
  mutate(size = case_when(st_crop_yr_co_prem &gt;= 1000000 ~ "MM+",
                          TRUE ~ "&lt; MM")) %&gt;%
  mutate(size = case_when(st_crop_yr_co_prem &gt;= 1000000 &amp;
                            stAbbr == "IA" ~ "MM+ in IA")) -&gt; 
  branch_example

branch_example %&gt;%
  filter(st_crop_yr_co_prem &gt;= 1000000) %&gt;%
  head
```

```
## # A tibble: 6 x 6
## # Groups:   year, stAbbr, cropName [1]
##    year stAbbr cropName coName   st_crop_yr_co_prem size     
##   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;                 &lt;dbl&gt; &lt;chr&gt;    
## 1  1989 IA     CORN     Boone               1013970 MM+ in IA
## 2  1989 IA     CORN     Buchanan            1162181 MM+ in IA
## 3  1989 IA     CORN     Cedar               1129430 MM+ in IA
## 4  1989 IA     CORN     Clayton             1184118 MM+ in IA
## 5  1989 IA     CORN     Clinton             1498374 MM+ in IA
## 6  1989 IA     CORN     Crawford            1230931 MM+ in IA
```

```r
branch_example %&gt;%
  filter(st_crop_yr_co_prem &gt;= 1000000) %&gt;%
  tail
```

```
## # A tibble: 6 x 6
## # Groups:   year, stAbbr, cropName [1]
##    year stAbbr cropName coName    st_crop_yr_co_prem size 
##   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;                  &lt;dbl&gt; &lt;chr&gt;
## 1  2018 NE     WHEAT    Box Butte            1644991 &lt;NA&gt; 
## 2  2018 NE     WHEAT    Cheyenne             2843502 &lt;NA&gt; 
## 3  2018 NE     WHEAT    Deuel                1133503 &lt;NA&gt; 
## 4  2018 NE     WHEAT    Hitchcock            1172246 &lt;NA&gt; 
## 5  2018 NE     WHEAT    Kimball              1168454 &lt;NA&gt; 
## 6  2018 NE     WHEAT    Perkins              1463128 &lt;NA&gt;
```
]
---
# Logical Branching FIXED! 


```r
st_crop_yr_co_prem %&gt;%
  mutate(size = case_when(st_crop_yr_co_prem &gt;= 1000000 ~ "MM+",
                          TRUE ~ "&lt; MM")) %&gt;%
  mutate(size = case_when(st_crop_yr_co_prem &gt;= 1000000 &amp;
                            stAbbr == "IA" ~ "MM+ in IA", 
*                         TRUE ~ size)) -&gt;
  branch_example
branch_example %&gt;%
  filter(st_crop_yr_co_prem &gt;= 1000000) %&gt;%
  tail
```

```
## # A tibble: 6 x 6
## # Groups:   year, stAbbr, cropName [1]
##    year stAbbr cropName coName    st_crop_yr_co_prem size 
##   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;                  &lt;dbl&gt; &lt;chr&gt;
## 1  2018 NE     WHEAT    Box Butte            1644991 MM+  
## 2  2018 NE     WHEAT    Cheyenne             2843502 MM+  
## 3  2018 NE     WHEAT    Deuel                1133503 MM+  
## 4  2018 NE     WHEAT    Hitchcock            1172246 MM+  
## 5  2018 NE     WHEAT    Kimball              1168454 MM+  
## 6  2018 NE     WHEAT    Perkins              1463128 MM+
```

---
# Branching Exercise

Let's make a scoring "plinko"! Creaate a new column called `score` and use the following rules. You'll need multiple `caase_when` steps. Don't forget your `else` condition at the end of each one. Or you'll get an `NA`. Remember to use `==`. And ***add*** your change to the score to your existing score.

Rules:

* score starts at 0
* If it's IA Corn then add 1
* If it's MN Wheat then subtract 2
* If it's NE add 3
* If it's Soybeans subtract 1

---

# possible solution...

.tiny[


```r
st_crop_yr_co_prem %&gt;%
  mutate(score = 0) %&gt;% 
  mutate(score = case_when( stAbbr == "IA" &amp; cropName == "CORN" ~ score + 1 , 
                            TRUE ~ score) ) %&gt;%
  mutate(score = case_when( stAbbr == "MN" &amp; cropName == "WHEAT" ~ score - 2  , 
                            TRUE ~ score) ) %&gt;%
  mutate(score = case_when( stAbbr == "NE"                       ~ score + 3  , 
                            TRUE ~ score) ) %&gt;%
  mutate(score = case_when( cropName == "SOYBEANS"               ~ score - 1  , 
                            TRUE ~ score) ) -&gt;
  solution_df

solution_df %&gt;%
  ungroup() %&gt;%
  summarize(score = sum(score))
```

```
## # A tibble: 1 x 1
##   score
##   &lt;dbl&gt;
## 1  6425
```
]
---
# Plinko Warning...

## Using a table and a join is more maintainable

---
# Export to fixed width

`readr` package is the fast tidyvere way to read/write data: `readr::write_*`

However...

![readr](03_images/readr.png)

---

# Export to fixed width

so I googled...

![readr](03_images/write.fwf.png)

Let's try it! 

`install.packages("gdata")`

---
# gdata::write.fwf


```r
library(gdata)

head(st_crop_yr_prem) 
```

```
## # A tibble: 6 x 4
## # Groups:   year, stAbbr [2]
##    year stAbbr cropName st_crop_yr_prem
##   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;              &lt;dbl&gt;
## 1  1989 IA     CORN            77710025
## 2  1989 IA     SOYBEANS        30831701
## 3  1989 IA     WHEAT              34462
## 4  1989 IL     CORN            36394094
## 5  1989 IL     SOYBEANS        17758248
## 6  1989 IL     WHEAT             634724
```

```r
st_crop_yr_prem %&gt;%  
  as.data.frame() %&gt;% # &lt;&lt;
  write.fwf(file = "test.fwf",
            colnames = FALSE,
            width = c(4, 2, 25, 15))
```
---

# Reading and writing from Excel

https://rc2e.com/inputandoutput#recipe-readexcel

https://rc2e.com/inputandoutput#recipe-writeexcel

---

# Learn More!

## *R Cookbook - 2nd ed.* - http://rc2e.com

## *R for Data Science* - https://r4ds.had.co.nz

## *R Graphics Cookbook - 2nd ed.* - https://r-graphics.org

---

# James (JD) Long

## Personal EMail - jdlong@gmail.com

## Twitter: @CMastication

---

# Artwork by @allison_horst

![notnorm](03_images/notnormal.jpg)
---

# Bonus Cheats... `↑↑↓↓←→←→BA`

## Interactive and debugging:

`library(clipr)` - copying R object contents to clipboard

`library(datapasta)` - pasting data into R scripts

---
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
