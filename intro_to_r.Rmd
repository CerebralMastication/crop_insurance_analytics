---
title: "Introduction to R"
subtitle: "<br/>with the Tidyverse<br/>and RMA SoB data"
author: "James (JD) Long"
institute: "Renaissance Reinsurance"
date: "updated: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    #css: [lucy, lucy-fonts]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(skimr)
hook_source <- knitr::knit_hooks$get('source')
knitr::knit_hooks$set(
  source = function(x, options) {
    x <-
      stringr::str_replace(x,
                           "^[[:blank:]]?([^*].+?)[[:blank:]]*#<<[[:blank:]]*$",
                           "*\\1")
    hook_source(x, options)
  }
)

```

```{css, echo = FALSE}

.huge .remark-code { /
  font-size: 150% !important;
}
.tiny .remark-code { 
  font-size: 50% !important;
}
.medium .remark-code { 
  font-size: 75% !important;
}
```

---
background-image: url("03_images/rcookbook.png")
background-position: center
background-size: contain

---
class: center, middle
# A Little About Me...

---

# Why am I doing this?

## Who's getting paid & how?

---
class: center, middle
# Why R? 

--

## Interactive

--

## Widely Used

--

## Data Analysis and Stats First

--

## Great Addon Packages (Tidyverse)

--



---

# What's up with the Tidyverse?

--

## Libraries that work well together

--

## Consistent Syntax

--

## Easier to Learn / Remember

--

## Sponsored by RStudio

---

# Tidyverse (core)

.pull-left[
## ðŸ‘‡ ***Our Focus Today***
### `dplyr` - data manupliation 
### `ggplot2` - visualization 
### `readr` - data import 
### `tidyr` - data rearrangement (tidy-ing)
]
.pull-right[
### `purrr` - functional programming with lists
### `tibble` - modern data frames
### `stringr` - string manipulation
### `forcats` - categorical data
]

---

background-image: url("03_images/konami.jpg")
background-position: center
background-size: contain

---

# Example Cheats

--
.pull-left[
## RStudio Add ins:
### `clipr` - output to clipboard
### `datapasta` - paste from clipboard
### `esquisse` - quick start graphs
]
--
.pull-right[
## Packages:
### `Tidyverse` - shared social norms
### `xlsx` - write to Excel

## Cheat Sheets:
### In the Help menu!
]

---

background-image: url("03_images/cheatsheets.png")
background-position: center
background-size: contain

---

background-image: url("03_images/dplyr_cheat.png")
background-position: center
background-size: contain

---

class: center, middle

# Let's Open<br/>`RStudio.cloud`

## http://bit.ly/fmh_r

Save the project to your workspace. 

---

background-image: url("03_images/rstudio.cloud.png")
background-position: center
background-size: contain

---

.center[
`ctrl + shift + n` - for new document

![hello_world](03_images/hello_world.png)

]

---

background-image: url("03_images/hello_yall.png")
background-position: center
background-size: contain

---

# Now your turn:


## Create a variable and shove some text into it with `<-`
## Then `print()` that to the screen


Save your script now. Update your script with each exercise. These are your notes for later. 
---

# Let's play with some data! 

---

```{r}
library(tidyverse)
```

---

```{r}
sob_limited_group_1 <- read_csv("01_data/sob_limited_group_1.csv")
```

---

# But what about equals signs?
```{r}
sob_limited_group_1 = read_csv("01_data/sob_limited_group_1.csv")
```


---

# But arrows are directional!
```{r}
read_csv("01_data/sob_limited_group_1.csv") ->
  sob_limited_group_1
```


---

# Control + Click on a data frame...

```r
View(sob_limited_group_1)
```

```r
sob_limited_group_1 %>%
   View
```

---

# wait.. wft is `%>%`?

--


![pipe](03_images/pipe.jpeg)

---

# Why Pipes?

## Traditional Syntax
```r
harvest(
  spray(
    fertilize(
      plant( some_acres, crop = "corn", ppa = 38000),
        n = 10, p = 10, k = 10), 
    plan = "roundup")
  )
```
-or- 
```r
planted_acres <- plant( some_acres, crop = "corn", ppa = 38000)
fert_planted_acres <- fertilize(planted_acres, 
                                n = 10, p = 10, k = 10)
spray_fert_planted_acres <- spray(fert_planted_acres, 
                                  plan = "roundup")
harvest(spray_fert_planted_acres)
```

---
# Pipe Hotness

.huge[
```r
some_acres %>%
  plant(crop = "corn", ppa = 38000) %>%
  fertilize(n=10, p=10, k=10) %>%
  spray(plan = "roundup") %>%
  harvest() ->
  corn_crop
```
]
---
  
# Or in Kentucky
.huge[
```r
bourbon_bottle %>%
  open(twist=â€œleftâ€) %>%
  pour(oz=4) %>%
  enjoy() ->
  bad_decisions
```
]

---

# Back to the data... 

---
# Type the data frame name into the console

```{r}
sob_limited_group_1
```
---
# Time to cheat... `â†‘â†‘â†“â†“â†â†’â†â†’BA`
```r
library(skimr)
```

--

.medium[
```{r highlight.output=c(11, 14)}

skim(sob_limited_group_1)

```
]

---

# `dplyr` verbs for manipulation

* `filter` - filter rows
* `select` - filter columns
* `mutate` - create new columns
* `group_by` - chunk that junk
* `summarize` - summery of each chunk
* `arrange` - sort order

---

# `filter` - filter rows

.medium[
```{r}
sob_limited_group_1 %>%
  filter(stAbbr == "IA" & cropName == "CORN") %>%
  skim
```
]

---

# `filter` supports nested parens

```{r, eval=FALSE}
sob_limited_group_1 %>%
  filter((stAbbr == "IA" & cropName == "CORN") |
           (stAbbr == "IL" & cropName == "SOYBEANS"))
```

The secret is: 
* `&` = and
* `|` = or

---

# `select` - pick columns

.medium[
```{r}
sob_limited_group_1 %>%
  filter((stAbbr == "IA" & cropName == "CORN") |
           (stAbbr == "IL" & cropName == "SOYBEANS")) %>%
  select(stAbbr, cropName)
```
]

---
# Exercise Time...

1. Take `sob_limited_group_1` and filter it to include all records for IA and MN, and only Corn for the rest of the states. 
1. keep only the following fields:
`year, stAbbr, coName, cropName, planAbbr, prem, indem`



5 minutes... use your post it notes
---

# Exercise Solution...            

--
.huge[
```{r}

sob_limited_group_1 %>%
  filter((stAbbr == "IA" | stAbbr == "MN") |
           (cropName == "CORN")) %>%
  select(year, stAbbr, coName, cropName, planAbbr, prem, indem) 

```  
]

---
# Double check: (bonus verb `distinct`)

```{r}

sob_limited_group_1 %>%
  filter((stAbbr == "IA" | stAbbr == "MN") |
           (cropName == "CORN")) %>%
  distinct(cropName, stAbbr) %>% 
  arrange( cropName, stAbbr)

```  

---

background-image: url("03_images/doing.gif")
background-position: center
background-size: contain

---

# `mutate` - create new columns           
.medium[
```r
dataframe %>%
  mutate( new_column = function(something) )
```
]

---

# `mutate` - create new columns           

```{r}
sob_limited_group_1 %>%
  filter((stAbbr == "IA" | stAbbr == "MN") |
           (cropName == "CORN")) %>%
  select(year, stAbbr, coName, cropName, planAbbr, prem, indem) %>%
  mutate(state_crop = paste(stAbbr, cropName)) #<<

```  

try it... 


---

# How to get help?

`?paste`

--

Google: R combine strings

![goog](03_images/google.png)

---


# Bonus: `rename` - guess what it does?

--

```{r}

sob_limited_group_1 %>%
  select(year, stAbbr, coName, cropName, planAbbr, prem, indem) %>%
  rename(county_name = coName) #<<

```  
Notice the argument order...

---

# `group_by` - change the grouping (resolution) of future operations

```{r, highlight.output=c(2)}
sob_limited_group_1 %>%
  group_by(year, stAbbr)
```

---
# `summarize` - do a group operation on grouped data

```{r}
sob_limited_group_1 %>%
  group_by(year, stAbbr) %>%
  summarize( prem = sum(prem)) ->
  state_prem

state_prem

```
Be sure and assign this one to a data frame object. We'll need that in a minute. 
---

# Cool story, bro... how about a graph?
.huge[

`â†‘â†‘â†“â†“â†â†’â†â†’BA`
```{r, eval=FALSE}
install.packages("esquisse")
```

/É›s.kis/

A quick first sketch of an idea.

`esquisse` gets us a fast first draft of a graph. It gives us `ggplot2` code we then customize. 
]
---


background-image: url("03_images/esquisse.png")
background-position: center
background-size: contain


---


![esquisse1](03_images/es1.png)
--
![esquisse2](03_images/es2.png)
--
![export](03_images/export.png)

---

# `esquisse` works best (only?) if you have your data aggregated to the unit of display

Generally this is true of `ggplot2` as well. 

---

# Let's talk about "long" vs "wide" data...

### If adding new data never adds columns, then your data is "long"

### Rule of thumb: keep your data long in storage and analysis until you ***really*** need it wide. Like to calculate correlations. 

![export](03_images/l_vs_w.png)

---

# ðŸ˜• - `ggplot` likes its data "long"

--

## Excel likes its data wide. 

--

This trips everybody up. 

---
# So how do we get make it a different shape?


## `pivot_wider` or `pivot_longer`

---

# let's `pivot_wider`
```{r}
state_prem %>%
  pivot_wider(names_from = stAbbr, 
              values_from = prem) ->
  wide_prem
wide_prem
```

---
# Let's calculate correlations, since we can

```{r}
wide_prem %>%
  ungroup() %>% #<<
  select(-year) %>% #<<
  cor()

```

---

---

